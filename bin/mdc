#!/bin/sh
# @(#) Convert Markdown to HTML. Version 1.0.0.20150205
# need Node.js, marked

readonly highlight_url=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/
readonly copyright_name=eel3

usage() {
    cat <<-EOF 1>&2
		usage: `basename "$0"` [-h] [-cgr] [-o output-file] [input-file]
		option:
		    -c  Enable code syntax highlight (using highlight.js).
		    -g  Add header with generated time.
		    -h  Show this text and exit.
		    -o  Specify file output. If none is specified, write to stdout.
		    -r  Add footer with copyright.
	EOF
    exit $1
}

opt=
color=false
gentime=false
output=
copyright=false
while getopts 'cgho:r' opt; do
    case $opt in
    c)      color=true ;;
    g)      gentime=true ;;
    h)      usage 0 ;;
    o)      output=$OPTARG ;;
    r)      copyright=true ;;
    \?)     usage 1 ;;
    esac
done
shift `expr $OPTIND - 1`

[ $# -le 1 ] || usage 1

if [ -n "$output" ]; then
    exec >"$output"
fi

cat <<'EOF'
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
EOF

if $color; then
    cat <<EOF
<link rel="stylesheet" href="${highlight_url}styles/github.min.css">
EOF
fi

cat <<'EOF'
<title></title>
<style type="text/css">
body {
  margin: 2em
}
dd, dt, li, p {
  line-height: 1.5em;
}
dd {
  margin-bottom: 0.7em;
  margin-left: 1em;
}
dt {
  font-style: oblique;
  font-weight: bold;
}
footer, header {
  background-color: #fc3;
  padding-left: 0.5em;
}
h1, h2 {
  border-bottom: 1px #E6E6FA solid;
  margin-top: 1.5em;
  padding-bottom: 0.3em;
}
h1 {
  font-size: 2.3em;
}
h2 {
  font-size: 1.9em;
}
h3 {
  font-size: 1.5em;
}
pre {
  background-color: #F8F8F8;
  padding: 0.7em;
}
table, th, td {
  border: 1px #E6E6FA solid;
  border-collapse: collapse;
}
th, td {
  padding: 0.7em;
}
</style>
</head>
<body>
EOF

if $gentime; then
    cat <<EOF
<header>
<p>Generated: `LANG=C date -u '+%a, %d %b %Y %T GMT'`</p>
</header>
EOF
fi

echo ''

marked --gfm --table --lang-prefix '' ${@+"$@"}

if $copyright; then
    cat <<EOF
<footer>
<p>&copy; `date '+%Y'` $copyright_name.</p>
</footer>
EOF
fi

if $color; then
    cat <<EOF
<script src="${highlight_url}highlight.min.js"></script>
<script src="${highlight_url}languages/applescript.min.js"></script>
<script src="${highlight_url}languages/clojure-repl.min.js"></script>
<script src="${highlight_url}languages/clojure.min.js"></script>
<script src="${highlight_url}languages/coffeescript.min.js"></script>
<script src="${highlight_url}languages/d.min.js"></script>
<script src="${highlight_url}languages/dart.min.js"></script>
<script src="${highlight_url}languages/dos.min.js"></script>
<script src="${highlight_url}languages/erb.min.js"></script>
<script src="${highlight_url}languages/erlang-repl.min.js"></script>
<script src="${highlight_url}languages/erlang.min.js"></script>
<script src="${highlight_url}languages/fsharp.min.js"></script>
<script src="${highlight_url}languages/go.min.js"></script>
<script src="${highlight_url}languages/groovy.min.js"></script>
<script src="${highlight_url}languages/haskell.min.js"></script>
<script src="${highlight_url}languages/lisp.min.js"></script>
<script src="${highlight_url}languages/lua.min.js"></script>
<script src="${highlight_url}languages/ocaml.min.js"></script>
<script src="${highlight_url}languages/powershell.min.js"></script>
<script src="${highlight_url}languages/processing.min.js"></script>
<script src="${highlight_url}languages/r.min.js"></script>
<script src="${highlight_url}languages/rust.min.js"></script>
<script src="${highlight_url}languages/scala.min.js"></script>
<script src="${highlight_url}languages/scheme.min.js"></script>
<script src="${highlight_url}languages/smalltalk.min.js"></script>
<script src="${highlight_url}languages/swift.min.js"></script>
<script src="${highlight_url}languages/tcl.min.js"></script>
<script src="${highlight_url}languages/typescript.min.js"></script>
<script src="${highlight_url}languages/vbnet.min.js"></script>
<script src="${highlight_url}languages/vbscript-html.min.js"></script>
<script src="${highlight_url}languages/vbscript.min.js"></script>
<script src="${highlight_url}languages/vim.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
EOF
fi

cat <<'EOF'
</body>
</html>
EOF
